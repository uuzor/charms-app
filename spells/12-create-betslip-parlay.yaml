version: 8

# Place a parlay betslip (multiple matches, all must win)
apps:
  $00: t/${app_id}/${app_vk}    # LEAGUE token
  $01: 15/${app_id}/${app_vk}   # BETSLIP_NFT
  $02: 16/${app_id}/${app_vk}   # LIQUIDITY_POOL_NFT

ins:
  # Bettor's tokens
  - utxo_id: ${bettor_token_utxo}
    charms:
      $00: ${total_stake}

  # Liquidity pool state
  - utxo_id: ${pool_utxo}
    charms:
      $02:
        pool_id: "${pool_id}"
        total_liquidity: ${current_total_liquidity}
        total_bets_in_play: ${current_bets_in_play}
        total_paid_out: ${current_paid_out}
        total_collected: ${current_collected}
        protocol_revenue: ${current_protocol_revenue}
        house_balance: ${current_house_balance}
        is_active: true
        min_liquidity: ${min_liquidity}
        total_shares: ${current_total_shares}  # V2: LP share tracking

outs:
  # Betslip NFT with multiple bets (parlay)
  - address: ${bettor_address}
    charms:
      $01:
        slip_id: "${slip_id}"
        bettor: "${bettor_address}"
        bet_type: "Parlay"
        bets:
          - match_id: "${match_id_1}"
            prediction: "${prediction_1}"
            odds: ${odds_1}
          - match_id: "${match_id_2}"
            prediction: "${prediction_2}"
            odds: ${odds_2}
          - match_id: "${match_id_3}"
            prediction: "${prediction_3}"
            odds: ${odds_3}
          # Can include up to 20 bets
        total_stake: ${total_stake}
        stake_per_bet: 0  # Not used for parlay
        potential_payout: ${potential_payout}  # Combined odds * stake * parlay_multiplier * (1 - house_edge)
        badges: ${badges_array}
        settled: false
        payout_amount: 0
        timestamp: ${timestamp}
        # V2: Odds-weighted allocations and capped multiplier
        allocations:
          - match_id: "${match_id_1}"
            allocation: ${allocation_1}  # Amount allocated to this match
          - match_id: "${match_id_2}"
            allocation: ${allocation_2}
          - match_id: "${match_id_3}"
            allocation: ${allocation_3}
        locked_multiplier: ${locked_multiplier}  # Capped parlay multiplier (10000-12500)

  # Updated liquidity pool
  - address: ${house_address}
    charms:
      $02:
        pool_id: "${pool_id}"
        total_liquidity: ${current_total_liquidity}
        total_bets_in_play: ${new_bets_in_play}  # += total_stake
        total_paid_out: ${current_paid_out}
        total_collected: ${new_collected}  # += total_stake
        protocol_revenue: ${current_protocol_revenue}
        house_balance: ${current_house_balance}
        is_active: true
        min_liquidity: ${min_liquidity}
        total_shares: ${current_total_shares}  # V2: LP share tracking

  # Tokens to house pool
  - address: ${house_address}
    charms:
      $00: ${total_stake}
