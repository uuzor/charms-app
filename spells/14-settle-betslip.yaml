version: 8

# Settle a betslip after all matches are resolved
apps:
  $00: t/${app_id}/${app_vk}    # LEAGUE token
  $01: 15/${app_id}/${app_vk}   # BETSLIP_NFT
  $02: 16/${app_id}/${app_vk}   # LIQUIDITY_POOL_NFT

ins:
  # Betslip to settle
  - utxo_id: ${betslip_utxo}
    charms:
      $01:
        slip_id: "${slip_id}"
        bettor: "${bettor_address}"
        bet_type: "${bet_type}"
        bets: ${bets_array}
        total_stake: ${total_stake}
        stake_per_bet: ${stake_per_bet}
        potential_payout: ${potential_payout}
        badges: ${badges_array}
        settled: false
        payout_amount: 0
        timestamp: ${timestamp}

  # Liquidity pool (to pay winner or collect loss)
  - utxo_id: ${pool_utxo}
    charms:
      $02:
        pool_id: "${pool_id}"
        total_liquidity: ${current_total_liquidity}
        total_bets_in_play: ${current_bets_in_play}
        total_paid_out: ${current_paid_out}
        total_collected: ${current_collected}
        protocol_revenue: ${current_protocol_revenue}
        house_balance: ${current_house_balance}
        is_active: true
        min_liquidity: ${min_liquidity}

  # House token pool (for payouts)
  - utxo_id: ${house_token_utxo}
    charms:
      $00: ${house_tokens}

outs:
  # If winner: payout to bettor
  - address: ${bettor_address}
    charms:
      $00: ${payout_amount}  # Calculated based on bet_type and results

  # Updated liquidity pool
  - address: ${house_address}
    charms:
      $02:
        pool_id: "${pool_id}"
        total_liquidity: ${current_total_liquidity}
        total_bets_in_play: ${new_bets_in_play}  # -= total_stake
        total_paid_out: ${new_paid_out}  # += payout_amount
        total_collected: ${current_collected}
        protocol_revenue: ${new_protocol_revenue}  # += protocol share
        house_balance: ${new_house_balance}  # Adjusted for payout/collection
        is_active: true
        min_liquidity: ${min_liquidity}

  # Remaining house tokens
  - address: ${house_address}
    charms:
      $00: ${remaining_house_tokens}

  # Settled betslip (marked as complete, optional to keep as receipt)
  - address: ${bettor_address}
    charms:
      $01:
        slip_id: "${slip_id}"
        bettor: "${bettor_address}"
        bet_type: "${bet_type}"
        bets: ${bets_array}
        total_stake: ${total_stake}
        stake_per_bet: ${stake_per_bet}
        potential_payout: ${potential_payout}
        badges: ${badges_array}
        settled: true
        payout_amount: ${payout_amount}
        timestamp: ${timestamp}
